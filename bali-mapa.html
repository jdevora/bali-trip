<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bali — Mapa interactivo</title>
  <style>
    :root{ --header-h:56px }
    html,body{margin:0;height:100%;background:#0f172a;color:#e5e7eb;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    header{position:sticky;top:0;z-index:10;background:rgba(15,23,42,.9);
      backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid #334155}
    .container{max-width:1100px;margin:0 auto;padding:0 16px}
    header .row{display:flex;align-items:center;justify-content:flex-start;min-height:var(--header-h)}
    .brand{font-weight:700}
    .sub{color:#94a3b8;margin:0 0 10px}
    main{padding:16px}
    #map{width:100%;height:calc(100dvh - var(--header-h) - 16px);min-height:500px;
      border:1px solid #334155;border-radius:12px}
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <header>
    <div class="container row">
      <div class="brand">Bali · Mapa interactivo</div>
    </div>
  </header>
  <main class="container">
    <p class="sub">Zonas base y puntos clave (playas, templos, cascadas y arrozales).</p>
    <div id="map" role="application" aria-label="Mapa de Bali"></div>
  </main>

  <script>
    const map = L.map('map', { center: [-8.45, 115.09], zoom: 10, scrollWheelZoom: true });
    L.control.scale().addTo(map);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Capas por categoría
    const gZonas = L.layerGroup().addTo(map);
    const gPlayas = L.layerGroup().addTo(map);
    const gAtracciones = L.layerGroup().addTo(map);
    const gCascadas = L.layerGroup().addTo(map);
    const gArrozales = L.layerGroup().addTo(map);

    // Iconos de color
    function coloredMarker(color){
      return L.icon({
        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
      });
    }

    // Zonas base
    const zonas = [
      { name: 'Ubud (base cultural)', lat:-8.5069, lng:115.2625, color:'green', html:'<h4>Ubud</h4><div>Templos, arrozales y cascadas; ideal 3–4 noches.</div>' },
      { name: 'Canggu (surf & cafés)', lat:-8.6478, lng:115.1385, color:'orange', html:'<h4>Canggu</h4><div>Ambiente joven, surf y vida social.</div>' },
      { name: 'Seminyak (chic & beach clubs)', lat:-8.6900, lng:115.1686, color:'violet', html:'<h4>Seminyak</h4><div>Gastronomía y clubs.</div>' },
      { name: 'Jimbaran (calma & marisco)', lat:-8.7796, lng:115.1682, color:'grey', html:'<h4>Jimbaran</h4><div>Playa tranquila y cenas en la arena.</div>' },
      { name: 'Uluwatu (acantilados)', lat:-8.8295, lng:115.0843, color:'red', html:'<h4>Uluwatu</h4><div>Playas de postal y templo con danza.</div>' },
      { name: 'Sanur (playa calmada)', lat:-8.6950, lng:115.2625, color:'blue', html:'<h4>Sanur</h4><div>Aguas tranquilas y amaneceres.</div>' },
      { name: 'Aeropuerto DPS', lat:-8.7482, lng:115.1675, color:'gold', html:'<h4>Aeropuerto DPS</h4><div>Llegada 22/11 17:30 · Salida 29/11 13:50.</div>' }
    ];
    zonas.forEach(z=>{
      L.marker([z.lat,z.lng], { icon: coloredMarker(z.color) })
        .bindPopup(z.html).bindTooltip(z.name).addTo(gZonas);
    });

    // Puntos por categorías
    const poiStyle = { color:'#dc2626', fillColor:'#f87171', fillOpacity:.4, weight:2, radius:8 };
    const playas = [
      { name:'Padang Padang Beach', lat:-8.8096, lng:115.1028, html:'<h4>Padang Padang</h4><div>Playa mítica de surf y baño.</div>' },
      { name:'Bingin Beach', lat:-8.8109, lng:115.1048, html:'<h4>Bingin</h4><div>Calas y escaleras entre acantilados.</div>' },
      { name:'Dreamland Beach', lat:-8.7925, lng:115.1038, html:'<h4>Dreamland</h4><div>Playa amplia con buenas olas.</div>' },
      { name:'Nyang Nyang Beach', lat:-8.8427, lng:115.0931, html:'<h4>Nyang Nyang</h4><div>Playa salvaje y poco concurrida.</div>' }
    ];
    const templos = [
      { name:'Tirta Empul', lat:-8.4159, lng:115.3140, html:'<h4>Tirta Empul</h4><div>Templo de purificación.</div>' },
      { name:'Goa Gajah', lat:-8.5191, lng:115.2900, html:'<h4>Goa Gajah</h4><div>Cueva del Elefante.</div>' },
      { name:'Uluwatu Temple', lat:-8.8291, lng:115.0844, html:'<h4>Uluwatu</h4><div>Danza kecak al atardecer.</div>' },
      { name:'Tanah Lot', lat:-8.6216, lng:115.0868, html:'<h4>Tanah Lot</h4><div>Templo costero icónico.</div>' }
    ];
    // Atracciones (extras que no encajan en otras categorías)
    const atraccionesExtras = [
      { name:'Amanecer en Monte Batur', lat:-8.239, lng:115.376, html:'<h4>Monte Batur</h4><div>Amanecer y trekking opcional.</div>' },
      { name:'Ubud Monkey Forest', lat:-8.519, lng:115.262, html:'<h4>Ubud Monkey Forest</h4><div>Santuario de monos y bosque sagrado.</div>' },
      { name:'Mercado de Ubud', lat:-8.5095, lng:115.2623, html:'<h4>Mercado de Ubud</h4><div>Artesanías y vida local.</div>' },
      { name:'Jimbaran (marisco en la arena)', lat:-8.7757, lng:115.1673, html:'<h4>Jimbaran</h4><div>Restaurantes de marisco al atardecer.</div>' },
      { name:'Finns Beach Club', lat:-8.6620, lng:115.1307, html:'<h4>Finns Beach Club</h4><div>Beach club en Berawa.</div>' },
      { name:'La Brisa Bali', lat:-8.6470, lng:115.1260, html:'<h4>La Brisa</h4><div>Beach club en Echo Beach.</div>' },
      { name:'Potato Head Beach Club', lat:-8.6825, lng:115.1466, html:'<h4>Potato Head</h4><div>Beach club en Seminyak.</div>' },
      { name:'Sundays Beach Club', lat:-8.8425, lng:115.1530, html:'<h4>Sundays Beach Club</h4><div>Calita en Ungasan.</div>' },
      // Nusa Penida puntos clave
      { name:'Kelingking (Nusa Penida)', lat:-8.7380, lng:115.4600, html:'<h4>Kelingking</h4><div>Mirador icónico.</div>' },
      { name:'Broken Beach (Nusa Penida)', lat:-8.7255, lng:115.4607, html:'<h4>Broken Beach</h4><div>Arco natural junto al mar.</div>' },
      { name:'Angel’s Billabong (Nusa Penida)', lat:-8.7251, lng:115.4644, html:'<h4>Angel’s Billabong</h4><div>Piscina natural.</div>' },
      { name:'Crystal Bay (Nusa Penida)', lat:-8.7209, lng:115.4571, html:'<h4>Crystal Bay</h4><div>Snorkel y atardecer.</div>' },
      // Lembongan / Ceningan
      { name:'Puente Amarillo (Lembongan–Ceningan)', lat:-8.6845, lng:115.4525, html:'<h4>Yellow Bridge</h4><div>Conexión Lembongan–Ceningan, buen punto para snorkel cercano.</div>' }
    ];
    atraccionesExtras.forEach(p=> L.circleMarker([p.lat,p.lng], poiStyle).bindPopup(p.html).bindTooltip(p.name).addTo(gAtracciones));

    const cascadas = [{ name:'Tegenungan Waterfall', lat:-8.5815, lng:115.2892, html:'<h4>Tegenungan</h4><div>Cascada popular cerca de Ubud.</div>' },
      { name:'Nungnung Waterfall', lat:-8.3730, lng:115.2375, html:'<h4>Nungnung</h4><div>Cascada potente.</div>' },
      { name:'Sekumpul Waterfall', lat:-8.2686, lng:115.1676, html:'<h4>Sekumpul</h4><div>Espectacular conjunto de saltos.</div>' },
      { name:'Tukad Cepung Waterfall', lat:-8.4336, lng:115.4285, html:'<h4>Tukad Cepung</h4><div>Rayo de luz en cañón.</div>' }
];
    const arrozales = [
      { name:'Tegallalang Rice Terrace', lat:-8.4353, lng:115.2799, html:'<h4>Tegallalang</h4><div>Arrozales en terrazas al norte de Ubud.</div>' }
    ];

    playas.forEach(p=> L.circleMarker([p.lat,p.lng], poiStyle).bindPopup(p.html).bindTooltip(p.name).addTo(gPlayas));
    templos.forEach(p=> L.circleMarker([p.lat,p.lng], poiStyle).bindPopup(p.html).bindTooltip(p.name).addTo(gAtracciones));
    cascadas.forEach(p=> L.circleMarker([p.lat,p.lng], poiStyle).bindPopup(p.html).addTooltip?null:0);
    cascadas.forEach(p=> L.circleMarker([p.lat,p.lng], poiStyle).bindPopup(p.html).bindTooltip(p.name).addTo(gCascadas));
    arrozales.forEach(p=> L.circleMarker([p.lat,p.lng], poiStyle).bindPopup(p.html).bindTooltip(p.name).addTo(gArrozales));

    // Capas conmutables
    L.control.layers({}, {
      'Zonas base': gZonas,
      'Playas': gPlayas,
      'Atracciones': gAtracciones,
      'Cascadas': gCascadas,
      'Arrozales': gArrozales
    }, { collapsed:true }).addTo(map);

    // Encuadre del área útil
    const visitBounds = L.latLngBounds([[-8.92, 114.95], [-8.15, 115.65]]);
    map.setMaxBounds(visitBounds.pad(0.1));
    map.fitBounds(visitBounds, { padding:[20,20] });

    // Redibujos seguros (iframe + visibilidad)
    setTimeout(()=> map.invalidateSize(), 60);
    window.addEventListener('resize', ()=> setTimeout(()=> map.invalidateSize(), 60));
    map.whenReady(() => {
      setTimeout(() => {
        map.invalidateSize();
        map.fitBounds(visitBounds, { padding:[20,20] });
      }, 200);
    });

    // Escuchar señal del padre
    window.addEventListener('message', (e)=>{
      if (e && e.data && e.data.type === 'map-visible') {
        setTimeout(() => {
          map.invalidateSize();
          map.fitBounds(visitBounds, { padding:[20,20] });
        }, 80);
      }
    });

    // Observador de tamaño: si cambia el layout del iframe, reajustar
    const ro = new ResizeObserver(()=>{
      setTimeout(()=>{
        map.invalidateSize();
      }, 60);
    });
    ro.observe(document.documentElement);
  </script>
</body>
</html>
